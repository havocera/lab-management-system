# 一体化容器：前端 + 后端 + MySQL
FROM ubuntu:22.04

# 设置环境变量避免交互式安装
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# 安装基础依赖
RUN apt-get update && apt-get install -y \
    nginx \
    mysql-server \
    php8.1-fpm \
    php8.1-mysql \
    php8.1-cli \
    php8.1-curl \
    php8.1-json \
    php8.1-mbstring \
    php8.1-xml \
    php8.1-zip \
    curl \
    supervisor \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# 安装Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# 设置工作目录
WORKDIR /app

# 复制项目文件
COPY package*.json ./
COPY . .

# 构建前端
RUN npm install --registry https://registry.npmmirror.com
RUN cp .env.docker .env.local
RUN npm run build

# 安装后端依赖
WORKDIR /app/endtp
RUN composer install --no-dev --optimize-autoloader

# 配置MySQL
RUN mkdir -p /var/run/mysqld && chown mysql:mysql /var/run/mysqld
RUN usermod -d /var/lib/mysql/ mysql

# 初始化MySQL数据库
RUN service mysql start && \
    mysql -u root -e "CREATE DATABASE IF NOT EXISTS labmanage;" && \
    mysql -u root -e "CREATE USER IF NOT EXISTS 'labuser'@'localhost' IDENTIFIED BY 'labpass123';" && \
    mysql -u root -e "GRANT ALL PRIVILEGES ON labmanage.* TO 'labuser'@'localhost';" && \
    mysql -u root -e "FLUSH PRIVILEGES;"

# 导入数据库结构
COPY labmanage.sql /tmp/
RUN service mysql start && mysql -u root labmanage < /tmp/labmanage.sql

# 配置Nginx
COPY nginx-all-in-one.conf /etc/nginx/sites-available/default

# 配置PHP-FPM
RUN sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/' /etc/php/8.1/fpm/php.ini

# 复制前端构建文件到Nginx目录
RUN cp -r /app/dist/* /var/www/html/

# 复制后端文件
RUN mkdir -p /var/www/api
RUN cp -r /app/endtp/* /var/www/api/

# 设置权限
RUN chown -R www-data:www-data /var/www/
RUN chmod -R 755 /var/www/

# 创建Supervisor配置
COPY supervisord-all-in-one.conf /etc/supervisor/conf.d/supervisord.conf

# 暴露端口
EXPOSE 80

# 启动Supervisor管理所有服务
CMD ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
